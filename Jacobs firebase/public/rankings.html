<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" type="text/css" href="css/styles.css" />
    <title>Game Rankings</title>
    <script
      src="https://code.jquery.com/jquery-3.5.1.js"
      integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc="
      crossorigin="anonymous"
    ></script>
    <style>
      /* Dark theme styles consistent with site */
      .ranking-container { max-width:900px; margin:28px auto; padding:18px; background:rgba(255,255,255,0.03); border-radius:8px; color: #fff; }
      .ranking-table { width:100%; border-collapse:collapse; margin-top:8px; }
      .ranking-table th, .ranking-table td { padding:8px 12px; border-bottom:1px solid rgba(255,255,255,0.04); text-align:left; }
      .ranking-table th { background: rgba(255,255,255,0.02); color:#ddd; font-weight:700; }
      .ranking-table tbody tr:nth-child(odd) { background: rgba(255,255,255,0.01); }
      .ranking-table td { color: #eee; }
      .nav-links { margin-bottom:12px; }
      .nav-links a { margin-right:12px; color:#9ad6ff; text-decoration:none; }
      code { background: rgba(255,255,255,0.02); padding:2px 6px; border-radius:4px; color:#cfefff; }
    </style>
  </head>
  <body>
    <div class="ranking-container">
        <div class="nav-links">
            <a href="index.html">Home</a>
            <a href="battle.html">PvP Battle</a>
            <a href="TitleScreen.html">Title Screen</a>
            <a href="PVE/selection.html">PVE Selection</a>
        </div>
    <h1>Game Rankings - Top 10 Players (by wins)</h1>
    <table class="ranking-table">
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Player Name</th>
                    <th>Score (wins)</th>
                </tr>
            </thead>
            <tbody>
        <tr>
          <td>1</td>
          <td id="player1-name">—</td>
          <td id="player1-score">0</td>
        </tr>
        <tr>
          <td>2</td>
          <td id="player2-name">—</td>
          <td id="player2-score">0</td>
        </tr>
        <tr>
          <td>3</td>
          <td id="player3-name">—</td>
          <td id="player3-score">0</td>
        </tr>
        <tr>
          <td>4</td>
          <td id="player4-name">—</td>
          <td id="player4-score">0</td>
        </tr>
        <tr>
          <td>5</td>
          <td id="player5-name">—</td>
          <td id="player5-score">0</td>
        </tr>
        <tr>
          <td>6</td>
          <td id="player6-name">—</td>
          <td id="player6-score">0</td>
        </tr>
        <tr>
          <td>7</td>
          <td id="player7-name">—</td>
          <td id="player7-score">0</td>
        </tr>
        <tr>
          <td>8</td>
          <td id="player8-name">—</td>
          <td id="player8-score">0</td>
        </tr>
        <tr>
          <td>9</td>
          <td id="player9-name">—</td>
          <td id="player9-score">0</td>
        </tr>
        <tr>
          <td>10</td>
          <td id="player10-name">—</td>
          <td id="player10-score">0</td>
        </tr>
            </tbody>
        </table>
    <p style="margin-top:12px;color:#666;font-size:13px;">This leaderboard displays the top 10 players by number of wins. It reads Firestore collection <code>scores</code> (Score field) and falls back to Realtime Database users/* wins if Firestore is not populated.</p>
    </div>

    <div id="ranking-status" style="max-width:900px;margin:6px auto;color:#f0f0f0;font-size:13px;text-align:center;"></div>

    <script type="module">
      (async function initRankings() {
        const status = (msg, isError = false) => {
          const el = document.getElementById('ranking-status');
          if (!el) return;
          el.textContent = msg || '';
          el.style.color = isError ? '#ffb3b3' : '#cfefff';
        };

        try {
          // Dynamically import Firebase modules so we can catch failures and show helpful messages
          const [{ initializeApp }, { getFirestore, collection, onSnapshot, query, orderBy, limit }, { getDatabase, ref: rtdbRef, onValue }] = await Promise.all([
            import('https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js'),
            import('https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js'),
            import('https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js')
          ]);

          // Replace with your Firebase config
          const firebaseConfig = {
  apiKey: "AIzaSyCAZCdpLSNAHhJMbX6XO7kM6OGEq1Wlp_g",
  authDomain: "arena-battlegrounds-2724e.firebaseapp.com",
  databaseURL: "https://arena-battlegrounds-2724e-default-rtdb.firebaseio.com",
  projectId: "arena-battlegrounds-2724e",
  storageBucket: "arena-battlegrounds-2724e.firebasestorage.app",
  messagingSenderId: "772072071103",
  appId: "1:772072071103:web:0ecb0d98cdbe1d39708b0a",
  measurementId: "G-G1Q86QFQBP"
};

          const app = initializeApp(firebaseConfig);
          const fs = getFirestore(app);
          const rdb = getDatabase(app);

          const updateDom = (rows) => {
            // Support up to top 10 rows on the page
            for (let i = 0; i < 10; i++) {
              const nameEl = document.getElementById(`player${i+1}-name`);
              const scoreEl = document.getElementById(`player${i+1}-score`);
              if (!nameEl || !scoreEl) continue;
              if (rows[i]) {
                nameEl.textContent = rows[i].Name || rows[i].name || rows[i].displayName || 'Player';
                scoreEl.textContent = String(Number(rows[i].Score || rows[i].wins || 0));
              } else {
                nameEl.textContent = '—'; scoreEl.textContent = '0';
              }
            }
          };

          // Try Firestore first
          try {
            status('Connecting to Firestore...');
            const scoresCol = collection(fs, 'scores');
            const q = query(scoresCol, orderBy('Score', 'desc'), limit(10));
            onSnapshot(q, (snapshot) => {
              const rankings = [];
              snapshot.forEach((doc) => rankings.push(doc.data()));
              if (rankings.length) {
                updateDom(rankings);
                status('Leaderboard loaded from Firestore.');
              } else {
                status('No Firestore data, falling back to Realtime DB...');
                fetchFromRealtime();
              }
            }, (err) => {
              console.error('Firestore leaderboard error', err);
              status('Firestore error — falling back to Realtime DB (see console).', true);
              fetchFromRealtime();
            });
          } catch (e) {
            console.warn('Firestore not available, falling back to Realtime DB', e);
            status('Firestore not available, using Realtime DB (if accessible).');
            fetchFromRealtime();
          }

          function fetchFromRealtime() {
            try {
              status('Connecting to Realtime Database...');
              const usersRef = rtdbRef(rdb, 'users');
              onValue(usersRef, (snap) => {
                const arr = [];
                const val = snap && snap.exists ? (snap.exists() ? snap.val() : {}) : (snap ? snap.val() : {});
                Object.keys(val || {}).forEach(uid => {
                  const u = val[uid] || {};
                  const wins = Number(u.wins || 0);
                  const name = u.displayName || u.name || (u.profile && u.profile.name) || uid;
                  arr.push({ Name: name, Score: wins });
                });
                arr.sort((a,b) => (b.Score||0)-(a.Score||0));
                updateDom(arr.slice(0,10));
                status('Leaderboard loaded from Realtime DB.');
              });
            } catch (e) { console.error('Realtime fallback failed', e); status('Realtime DB error (see console).', true); }
          }

        } catch (err) {
          console.error('Failed to load Firebase modules or init failed', err);
          const el = document.getElementById('ranking-status');
          if (el) el.textContent = 'Error loading leaderboard — check console for details.';
        }
      })();
    </script>
  </body>
</html>
